---
// Global keyboard navigation handler
// j/k: scroll, 1-4: page nav, t: theme toggle, c: random color, ?: help, :: command bar
---

<script>
  const RANDOM_PALETTE = [
    '#8141e6', // violet
    '#eab308', // gold
    '#2563eb', // blue
    '#e8536d', // hot pink
  ]

  function nextColor(current?: string): string {
    const idx = current ? RANDOM_PALETTE.indexOf(current) : -1
    return RANDOM_PALETTE[(idx + 1) % RANDOM_PALETTE.length]
  }

  function hexToRgb(hex: string): [number, number, number] {
    const n = parseInt(hex.slice(1), 16)
    return [(n >> 16) & 255, (n >> 8) & 255, n & 255]
  }

  function relativeLuminance(r: number, g: number, b: number): number {
    const [rs, gs, bs] = [r, g, b].map((c) => {
      c /= 255
      return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)
    })
    return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs
  }

  function clamp(v: number): number {
    return Math.max(0, Math.min(255, v))
  }

  function deriveTokens(bgHex: string): Record<string, string> {
    const [r, g, b] = hexToRgb(bgHex)
    const lum = relativeLuminance(r, g, b)
    const isDark = lum < 0.179
    const fg = isDark ? '#ffffff' : '#000000'
    const shift = isDark ? 25 : -25
    const br = clamp(r + shift)
    const bg2 = clamp(g + shift)
    const bb = clamp(b + shift)
    const border = '#' + [br, bg2, bb].map((c) => c.toString(16).padStart(2, '0')).join('')
    const muted = isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.55)'
    return {
      '--bg': bgHex,
      '--fg': fg,
      '--accent': fg,
      '--accent-glow': fg,
      '--muted': muted,
      '--border': border,
    }
  }

  function applyRandomTokens(tokens: Record<string, string>) {
    const el = document.documentElement
    for (const [key, value] of Object.entries(tokens)) {
      el.style.setProperty(key, value)
    }
  }

  function clearRandomTokens() {
    const el = document.documentElement
    const props = ['--bg', '--fg', '--accent', '--accent-glow', '--muted', '--border']
    for (const prop of props) {
      el.style.removeProperty(prop)
    }
  }

  function activateRandomMode() {
    const current = sessionStorage.getItem('random-bg') || undefined
    const bgHex = nextColor(current)
    const tokens = deriveTokens(bgHex)
    applyRandomTokens(tokens)
    sessionStorage.setItem('random-mode', '1')
    sessionStorage.setItem('random-bg', bgHex)
    const icon = document.querySelector('#theme-toggle .theme-icon')
    if (icon) icon.textContent = 'random'
    document.dispatchEvent(new CustomEvent('random-theme-changed'))
  }

  function exitRandomMode() {
    clearRandomTokens()
    sessionStorage.removeItem('random-mode')
    sessionStorage.removeItem('random-bg')
    const theme = localStorage.getItem('theme') ||
      (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark')
    document.documentElement.setAttribute('data-theme', theme)
    const icon = document.querySelector('#theme-toggle .theme-icon')
    if (icon) icon.textContent = theme === 'dark' ? 'light' : 'dark'
    document.dispatchEvent(new CustomEvent('random-theme-changed'))
  }

  document.addEventListener('activate-random', activateRandomMode)
  document.addEventListener('exit-random', exitRandomMode)

  function handleKeyboard(e: KeyboardEvent) {
    const target = e.target as HTMLElement
    if (
      target.tagName === 'INPUT' ||
      target.tagName === 'TEXTAREA' ||
      target.isContentEditable
    ) {
      return
    }

    const pages = ['/', '/work', '/cv', '/links']
    const current = window.location.pathname.replace(/\/$/, '') || '/'
    const idx = pages.indexOf(current)

    const pc = document.querySelector('.page-content')

    switch (e.key) {
      case 'ArrowUp':
      case 'k':
        if (pc) pc.scrollTop -= 60
        break
      case 'ArrowDown':
      case 'j':
        if (pc) pc.scrollTop += 60
        break
      case 'ArrowLeft':
        if (idx > 0) window.location.href = pages[idx - 1]
        break
      case 'ArrowRight':
        if (idx < pages.length - 1) window.location.href = pages[idx + 1]
        break
      case '1':
        window.location.href = '/'
        break
      case '2':
        window.location.href = '/work'
        break
      case '3':
        window.location.href = '/cv'
        break
      case '4':
        window.location.href = '/links'
        break
      case 'c':
        activateRandomMode()
        break
      case 't': {
        if (sessionStorage.getItem('random-mode') === '1') {
          exitRandomMode()
          break
        }
        const current = document.documentElement.getAttribute('data-theme')
        const next = current === 'dark' ? 'light' : 'dark'
        document.documentElement.setAttribute('data-theme', next)
        localStorage.setItem('theme', next)
        const icon = document.querySelector('#theme-toggle .theme-icon')
        if (icon) {
          icon.textContent = next === 'dark' ? 'light' : 'dark'
        }
        break
      }
      case '?':
        document.dispatchEvent(new CustomEvent('toggle-help'))
        break
      case ':':
        e.preventDefault()
        document.dispatchEvent(new CustomEvent('toggle-command'))
        break
    }
  }

  document.addEventListener('keydown', handleKeyboard)
</script>
