---
import bootMessagesData from '@data/assets/boot-messages.json'

const bootMessages = bootMessagesData.messages
---

<div id="boot-screen" class="boot-screen hidden" aria-hidden="true" transition:persist>
  <div id="boot-messages" class="boot-messages"></div>
</div>

<style>
  .boot-screen {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background-color: var(--bg);
    display: flex;
    align-items: flex-start;
    padding: 2rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    overflow: hidden;
  }

  .boot-screen.hidden {
    display: none;
  }

  .boot-messages {
    width: 100%;
    max-width: 80ch;
  }

  .boot-line {
    /* Lines appear instantly â€” no fade */
  }

  .boot-line.system {
    color: var(--fg);
  }
  .boot-line.info {
    color: var(--muted);
  }
  .boot-line.success {
    color: var(--accent);
  }
  .boot-line.accent {
    color: var(--accent);
    font-weight: bold;
  }

  .boot-cursor {
    display: inline;
    color: var(--accent);
  }

  .boot-cursor.blinking {
    animation: cursor-blink 1.06s step-end infinite;
  }

  @media (prefers-reduced-motion: reduce) {
    .boot-screen {
      display: none;
    }
  }
</style>

<script is:inline define:vars={{ bootMessages }}>
  if (!sessionStorage.getItem('boot-done')) {
    const screen = document.getElementById('boot-screen')
    const container = document.getElementById('boot-messages')
    let currentIndex = 0
    let timer = null
    const delay = 80
    const finalLineDelay = 150
    let cursor = null

    function createCursor() {
      cursor = document.createElement('span')
      cursor.className = 'boot-cursor'
      cursor.textContent = '\u2588'
      cursor.setAttribute('aria-hidden', 'true')
      return cursor
    }

    function addMessage() {
      if (currentIndex >= bootMessages.length) {
        // Start blinking cursor after all lines
        if (cursor) cursor.classList.add('blinking')
        // Pause with blinking cursor before dismissal
        timer = setTimeout(finish, 500)
        return
      }

      const msg = bootMessages[currentIndex]
      const line = document.createElement('div')
      line.className = 'boot-line ' + msg.type
      line.textContent = msg.text

      // Move cursor to end of latest line
      if (cursor && cursor.parentNode) {
        cursor.parentNode.removeChild(cursor)
      }
      if (!cursor) cursor = createCursor()
      line.appendChild(cursor)
      cursor.classList.remove('blinking')

      container.appendChild(line)
      currentIndex++

      // Use longer delay before the final line
      const nextDelay =
        currentIndex === bootMessages.length - 1 ? finalLineDelay : delay
      timer = setTimeout(addMessage, nextDelay)
    }

    function finish() {
      sessionStorage.setItem('boot-done', '1')
      document.removeEventListener('keydown', skipBoot)
      document.removeEventListener('click', skipBoot)
      setTimeout(function () {
        if (screen) {
          screen.style.transition = 'opacity 0.3s ease'
          screen.style.opacity = '0'
          setTimeout(function () {
            screen.classList.add('hidden')
          }, 300)
        }
      }, 0)
    }

    function skipBoot() {
      if (timer) clearTimeout(timer)
      sessionStorage.setItem('boot-done', '1')
      if (screen) {
        screen.classList.add('hidden')
      }
      document.removeEventListener('keydown', skipBoot)
      document.removeEventListener('click', skipBoot)
    }

    document.addEventListener('keydown', skipBoot)
    document.addEventListener('click', skipBoot)

    // Show boot screen (starts hidden to prevent flash on client-side nav)
    if (screen) screen.classList.remove('hidden')
    addMessage()
  }
</script>
