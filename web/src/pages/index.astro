---
import Base from '@layouts/Base.astro'
import Nav from '@components/Nav.astro'
import StatusBar from '@components/StatusBar.astro'
import AsciiPortrait from '@components/AsciiPortrait.astro'
import portraitData from '@data/assets/portrait.json'
import { getMeta, getAbout } from '../lib/data'

const meta = getMeta()
const about = getAbout()
---

<Base title={meta.name} description={meta.oneLiner}>
  <Nav current="home" />

  <div class="page-content">
    <section class="about" aria-label="About">
      <div class="about-content">
        <AsciiPortrait portraitData={portraitData} class="home-portrait" />

        <div class="about-text" data-stream>
          <p>{about.bio}</p>

          <div class="details">
            <p><span class="label">Location:</span> {about.location}</p>
            <p><span class="label">Status:</span> {about.status}</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <StatusBar center="←/→ nav · r random · ? help" />
</Base>

<script>
  function streamText(container: HTMLElement) {
    const nodes: { node: Text; text: string }[] = []

    function collectTextNodes(el: Node) {
      for (const child of Array.from(el.childNodes)) {
        if (child.nodeType === Node.TEXT_NODE && child.textContent?.trim()) {
          nodes.push({ node: child as Text, text: child.textContent! })
          ;(child as Text).textContent = ''
        } else if (child.nodeType === Node.ELEMENT_NODE) {
          collectTextNodes(child)
        }
      }
    }

    collectTextNodes(container)
    container.style.visibility = 'visible'

    const cursor = document.createElement('span')
    cursor.className = 'stream-cursor'
    cursor.textContent = '\u2588'

    let nodeIdx = 0
    let charIdx = 0
    const charDelay = 18

    function tick() {
      if (nodeIdx >= nodes.length) {
        cursor.remove()
        return
      }

      const { node, text } = nodes[nodeIdx]
      node.textContent = text.slice(0, charIdx + 1)

      cursor.remove()
      node.parentNode?.insertBefore(cursor, node.nextSibling)

      charIdx++
      if (charIdx >= text.length) {
        nodeIdx++
        charIdx = 0
      }

      setTimeout(tick, charDelay)
    }

    tick()
  }

  function init() {
    const el = document.querySelector<HTMLElement>('[data-stream]')
    if (el) {
      el.style.visibility = 'hidden'
      streamText(el)
    }
  }

  init()
  document.addEventListener('astro:after-swap', init)
</script>

<style>
  .about {
    padding: 0;
  }

  .about-content {
    display: flex;
    gap: 2rem;
    align-items: center;
  }

  .about-text {
    flex: 1;
    min-width: 0;
  }

  .details p {
    margin-bottom: 0.25rem;
  }

  .label {
    color: var(--accent);
    font-weight: 700;
  }

  .about-text :global(.stream-cursor) {
    color: var(--accent);
    animation: blink 600ms step-end infinite;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  .about-content :global(.home-portrait) {
    font-size: 0.35rem;
  }

  @media (max-width: 640px) {
    .about-content {
      flex-direction: column;
    }
  }
</style>
